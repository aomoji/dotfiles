{{- if and (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.variant "Silverblue") -}}
#!/bin/bash
set -euo pipefail

if rpm-ostree status | grep -q 'Diff:'; then
  echo "ℹ️  Pending deployment detected. Please run 'systemctl reboot', then run 'chezmoi apply' again."
  exit 0
fi

echo "==> Installing Fedora packages (batch with rpm-ostree)..."

# 一括インストール候補
CLI_PKGS=(
  # For openssl begin
  pkgconf
  perl-FindBin
  perl-IPC-Cmd
  openssl-devel
  # For openssl end
  neovim
  zsh
  lazygit
  direnv
  nkf
  fzf
)

# 既に入っているものを除外して、必要分だけを1回で適用
MISSING=()
for pkg in "${CLI_PKGS[@]}"; do
  if rpm -q "$pkg" >/dev/null 2>&1; then
    echo "✓ $pkg already installed."
  else
    MISSING+=("$pkg")
  fi
done

if [[ ${#MISSING[@]} -gt 0 ]]; then
  echo "→ Installing (batch): ${MISSING[*]}"
  rpm-ostree install -y "${MISSING[@]}"
  echo
  echo ">>> Please reboot, then run: chezmoi apply <<<"
else
  echo "✅ Nothing to install."
fi
{{- end -}}
