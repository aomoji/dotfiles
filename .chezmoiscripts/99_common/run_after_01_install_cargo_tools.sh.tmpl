#!/bin/bash
set -euo pipefail
{{ if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.variant "Silverblue") }}
if rpm-ostree status | grep -q 'Diff:'; then
  echo "ℹ️  Pending deployment detected. Please run 'systemctl reboot', then run 'chezmoi apply' again."
  exit 1
fi
{{ end }}

# Rustup で Rust & Cargo をインストール
if ! command -v cargo >/dev/null 2>&1; then
  echo "Installing rustup..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
  export PATH="$HOME/.cargo/bin:$PATH"
else
  echo "Cargo is already installed."
fi

# インストールする前にrustupをアップデート
if command -v rustup >/dev/null 2>&1; then
  rustup set profile minimal
  rustup update stable
  rustup default stable
fi

echo "==> Installing Rust tools from cargo package list..."

PACKAGE_FILE="$HOME/.config/cargo/packages.txt"

if [ ! -f "$PACKAGE_FILE" ]; then
  echo "❌ package list file not found: $PACKAGE_FILE"
  exit 1
fi

export PATH="$HOME/.cargo/bin:$PATH"

# cargo-update が無ければ入れる
if ! command -v cargo-install-update >/dev/null 2>&1; then
  cargo install cargo-update
fi

# 先に更新
cargo install-update -a

while read -r crate; do
  # crate名と実行ファイル名が異なるものの最小マップ
  bin="$crate"
  case "$crate" in
    git-delta) bin="delta" ;;
    skim)      bin="sk"    ;;
  esac
  if ! command -v "$bin" >/dev/null 2>&1; then
    echo "Installing $crate..."
    cargo install "$crate"
  else
    echo "$crate is already installed."
  fi
done < "$PACKAGE_FILE"

# Other special cases.
if ! command -v uv >/dev/null 2>&1; then
    echo "Installing uv..."
    cargo install --git https://github.com/astral-sh/uv uv
else
  echo "uv is already installed."
fi
